#!/usr/bin/env python
"""
This script checks that all terraform directories under the directory provided contain backend configs.

Usage:
    backend_check [options] [PATH]

Arguments:
    PATH    The path of the directory to check. Defaults to the current working directory.

Options:
    -h, --help          Show this message and exit.
    --version           Show the version.
"""
import os
import sys

import hcl
from docopt import docopt

from terrawrap.version import __version__


def main():
    arguments = docopt(__doc__, version=__version__)
    target_dir = arguments["PATH"] if arguments["PATH"] else os.getcwd()

    config_dirs = {
        current_dir: [file for file in files if file.endswith(".tf")]
        for current_dir, dirs, files in os.walk(target_dir, followlinks=True)
        if ".terraform" not in current_dir
           and any(entry.endswith(".tf") for entry in files)
    }

    config_dirs_with_terraform_backend = set()

    for config_dir, files in config_dirs.items():
        # Traditionally we put this in a backend.tf file, so check for it there first.
        if "backend.tf" in files:
            if does_file_define_backend(file_path=os.path.join(config_dir, "backend.tf")):
                config_dirs_with_terraform_backend.add(config_dir)
                continue

        # However, if it isn't in that file, let's check all the other files, just in case.
        for file in files:
            if does_file_define_backend(file_path=os.path.join(config_dir, file)):
                config_dirs_with_terraform_backend.add(config_dir)
                break

    config_dirs_without_terraform_backend = set(config_dirs.keys()) - config_dirs_with_terraform_backend
    if config_dirs_without_terraform_backend:
        print("The following config directories do not have Terraform Backends defined:")
        for config_dir in config_dirs_without_terraform_backend:
            print("\t", config_dir)
        print("\nPlease define a Terraform Backend: https://www.terraform.io/docs/backends/")
        sys.exit(1)


def does_file_define_backend(file_path: str):
    with open(file_path, "r") as file_source:
        parsed_file_source = hcl.load(file_source)
    return parsed_file_source.get("terraform", {}).get("backend")


if __name__ == '__main__':
    main()
